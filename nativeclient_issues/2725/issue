<ns0:entry xmlns:ns0="http://www.w3.org/2005/Atom" xmlns:ns1="http://schemas.google.com/g/2005" xmlns:ns2="http://schemas.google.com/projecthosting/issues/2009" ns1:etag="W/&quot;CEABSX47eCl7ImA9WhVXEU0.&quot;">
		<ns0:id>http://code.google.com/feeds/issues/p/nativeclient/issues/full/2725</ns0:id><ns0:author>
			<ns0:name>b...@google.com</ns0:name><ns0:uri>/u/105821748722532785568/</ns0:uri></ns0:author><ns0:content type="html">since getdents, open, etc are behind the -a flag, this has no impact on end users, just people porting middleware that want to use -a for autoconf-like activities.

the problem:  windows getdents implementation tries to convert from wchar_t component names to utf8 using _snprintf_s with &amp;quot;%ws&amp;quot;, but that doesn't work -- it's just converting to mbcs using the default code page (i think), which is CP_ACP (ANSI code page).  and if the Unicode character cannot be represented, _snprintf_s will fail, with errno set to EILSEQ (Illegal byte sequence, 42).

it's not clear it's worth the effort to make this work in a cleaner way, since most middleware probably (?) won't need to read directories containing Unicode characters.  if we do decide to pursue this, we should consider using WideCharToMultiByte with CP_UTF8 to convert name components to UTF8 before returning to user code, and correspondingly using MultiByteToWideChar in NaClHostOpen to convert from UTF8 to wchar_t and invoking _wsopen_s instead of _sopen_s.  this, however, introduces the conundrum that user code in Unix-style OSes can use arbitrary binary characters as filename components (excepting slash and ASCII NUL), and invalid Unicode code points would not work with MultiByteToWideChar, introducing a platform difference.  (We could check for valid UTF8 on Linux and OSX to enforce this, but then we might have a file the name of which is an invalid UTF8 string.)

Yuck.</ns0:content><ns0:updated>2012-04-11T00:05:58.000Z</ns0:updated><ns0:published>2012-04-10T22:39:05.000Z</ns0:published><ns2:status>New</ns2:status><ns2:state>open</ns2:state><ns0:title>windows getdents will fail if directory contains unicode named files</ns0:title><ns2:label>Type-Defect</ns2:label><ns2:label>Mstone-X</ns2:label><ns2:label>Pri-2</ns2:label><ns2:label>Component-TCB</ns2:label><ns2:label>OS-Windows</ns2:label><ns2:label>Arch-All</ns2:label><ns0:link href="http://code.google.com/feeds/issues/p/nativeclient/issues/2725/comments/full" rel="replies" type="application/atom+xml" /><ns0:link href="http://code.google.com/p/nativeclient/issues/detail?id=2725" rel="alternate" type="text/html" /><ns0:link href="https://code.google.com/feeds/issues/p/nativeclient/issues/full/2725" rel="self" type="application/atom+xml" /><ns2:stars>1</ns2:stars><ns2:id>2725</ns2:id></ns0:entry>